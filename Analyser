import pandas as pd
import tkinter as tk
from tkinter import ttk, messagebox
import webbrowser

# --- CLASSE LOGIQUE (LE CERVEAU) ---
class SteamDataManager:
    """G√®re le chargement, le nettoyage et le filtrage des donn√©es Steam."""
    
    def __init__(self, file_path):
        self.df = self._load_and_clean(file_path)

    def _load_and_clean(self, path):
        try:
            df = pd.read_csv(path)
            # Extraction propre des prix et r√©ductions
            df['Prix_Net'] = df['Infos Prix'].str.extract(r'√†\s*([\d,]+)').replace(',', '.', regex=True).astype(float)
            df['Reduc_Val'] = df['Infos Prix'].str.extract(r'(\d+)\s*%').astype(float).fillna(0)
            
            # Nettoyage des textes pour la recherche
            df['Avis_Lower'] = df['Avis'].str.lower().fillna("")
            df['Tags'] = df['Tags'].fillna("")
            df['Lien'] = df['Lien'].fillna("")
            return df
        except Exception as e:
            print(f"Erreur lors de la lecture des donn√©es : {e}")
            return None

    def get_unique_tags(self):
        """R√©cup√®re la liste de tous les tags disponibles sans doublons."""
        if self.df is None: return []
        all_tags = set()
        for row in self.df['Tags'].str.split(','):
            all_tags.update([t.strip() for t in row if t.strip()])
        return sorted(list(all_tags))

    def filter_games(self, min_reduc, max_price, sentiment, selected_tags):
        """Applique les filtres et retourne un DataFrame de r√©sultats."""
        mask = (self.df['Reduc_Val'] >= min_reduc) & \
               (self.df['Prix_Net'] <= max_price) & \
               (self.df['Avis_Lower'].str.contains(sentiment))

        for tag in selected_tags:
            if tag != "Aucun":
                mask = mask & (self.df['Tags'].str.contains(tag, case=False))
        
        return self.df[mask]


# --- CLASSE INTERFACE R√âSULTATS (LA LISTE) ---
class ResultsWindow(tk.Toplevel):
    """Fen√™tre secondaire affichant les jeux trouv√©s avec support de la molette."""
    
    def __init__(self, parent, results):
        super().__init__(parent)
        self.title(f"P√©pites trouv√©es ({len(results)})")
        self.geometry("450x500")
        self._build_ui(results)

    def _build_ui(self, results):
        self.canvas = tk.Canvas(self) # On le garde en self pour y acc√©der plus tard
        scrollbar = ttk.Scrollbar(self, orient="vertical", command=self.canvas.yview)
        scrollable_frame = ttk.Frame(self.canvas)

        scrollable_frame.bind(
            "<Configure>", 
            lambda e: self.canvas.configure(scrollregion=self.canvas.bbox("all"))
        )
        
        self.canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        self.canvas.configure(yscrollcommand=scrollbar.set)

        # --- AJOUT DU BINDING POUR LA MOLETTE ---
        # Pour Windows et MacOS
        self.bind_all("<MouseWheel>", self._on_mousewheel)
        # Pour Linux (boutons 4 et 5)
        self.bind_all("<Button-4>", self._on_mousewheel)
        self.bind_all("<Button-5>", self._on_mousewheel)

        for _, game in results.iterrows():
            card = ttk.Frame(scrollable_frame, padding=10)
            card.pack(fill=tk.X)

            link_label = tk.Label(card, text=game['Titre'], fg="#1a73e8", cursor="hand2", 
                                  font=("Helvetica", 11, "bold", "underline"), wraplength=400, justify="left")
            link_label.pack(anchor=tk.W)
            link_label.bind("<Button-1>", lambda e, url=game['Lien']: webbrowser.open_new(url))

            info_text = f"üí∞ {game['Prix_Net']}‚Ç¨ | R√©duction : -{int(game['Reduc_Val'])}%"
            tk.Label(card, text=info_text, font=("Helvetica", 9)).pack(anchor=tk.W)
            
            ttk.Separator(scrollable_frame, orient='horizontal').pack(fill='x', padx=20, pady=5)

        self.canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")

    def _on_mousewheel(self, event):
        """G√®re le d√©filement selon l'OS."""
        if event.num == 4: # Linux scroll up
            self.canvas.yview_scroll(-1, "units")
        elif event.num == 5: # Linux scroll down
            self.canvas.yview_scroll(1, "units")
        else: # Windows & MacOS
            self.canvas.yview_scroll(int(-1*(event.delta/120)), "units")


# --- CLASSE PRINCIPALE (L'APPLICATION) ---
class SteamHunterApp:
    def __init__(self, root, file_path):
        self.root = root
        self.root.title("Steam Hunter v3.0")
        self.root.geometry("500x750")
        
        # Initialisation de la donn√©e
        self.data_manager = SteamDataManager(file_path)
        
        if self.data_manager.df is not None:
            self._setup_main_ui()
        else:
            messagebox.showerror("Erreur Fatale", "Fichier de donn√©es introuvable ou corrompu.")

    def _setup_main_ui(self):
        main_container = ttk.Frame(self.root, padding="25")
        main_container.pack(fill=tk.BOTH, expand=True)

        ttk.Label(main_container, text="üéØ Steam Hunter", font=('Helvetica', 18, 'bold')).pack(pady=15)

        # Configuration des menus d√©roulants
        self.reduc_var = self._create_label_and_cb(main_container, "R√©duction minimum :", 
                                                   [f"{i}%" for i in range(0, 100, 5)], "10%")
        
        self.avis_var = self._create_label_and_cb(main_container, "Avis des joueurs :", 
                                                  ["positives", "moyennes", "n√©gatives"], "positives")
        
        self.prix_var = self._create_label_and_cb(main_container, "Budget max (‚Ç¨) :", 
                                                  [f"{i}" for i in range(0, 105, 5)], "35")

        # Section Tags
        ttk.Separator(main_container, orient='horizontal').pack(fill='x', pady=20)
        ttk.Label(main_container, text="Filtres par Tags (max 3) :", font=('Helvetica', 10, 'bold')).pack(anchor=tk.W)

        tag_list = ["Aucun"] + self.data_manager.get_unique_tags()
        self.tag_vars = []
        for _ in range(3):
            var = tk.StringVar(value="Aucun")
            cb = ttk.Combobox(main_container, textvariable=var, values=tag_list, state="readonly")
            cb.pack(fill=tk.X, pady=3)
            self.tag_vars.append(var)

        # Bouton d'action
        btn = ttk.Button(main_container, text="CHASSER LES OFFRES", command=self._on_search_clicked)
        btn.pack(fill=tk.X, pady=30)

    def _create_label_and_cb(self, parent, label_text, values, default):
        """Helper pour cr√©er rapidement un label + combobox."""
        ttk.Label(parent, text=label_text, font=('Helvetica', 10, 'bold')).pack(anchor=tk.W, pady=(10, 0))
        var = tk.StringVar(value=default)
        cb = ttk.Combobox(parent, textvariable=var, values=values, state="readonly")
        cb.pack(fill=tk.X, pady=5)
        return var

    def _on_search_clicked(self):
        # Extraction des valeurs
        try:
            reduc = float(self.reduc_var.get().replace('%', ''))
            budget = float(self.prix_var.get())
            sentiment = self.avis_var.get()
            tags = [v.get() for v in self.tag_vars]

            results = self.data_manager.filter_games(reduc, budget, sentiment, tags)

            if not results.empty:
                ResultsWindow(self.root, results)
            else:
                messagebox.showinfo("Bredouille", "Aucun jeu ne correspond √† vos crit√®res.")
        except ValueError:
            messagebox.showwarning("Attention", "Veuillez v√©rifier vos filtres.")

if __name__ == "__main__":
    root = tk.Tk()
    app = SteamHunterApp(root, "jeux_steam.csv")
    
    root.mainloop()

    # --- G√âN√âRATION AUTOMATIQUE DU REQUIREMENTS.TXT ---
    print("G√©n√©ration du fichier de d√©pendances...")
    try:
        import subprocess
        with open("requirements.txt", "w", encoding="utf-8") as f:
            subprocess.run(["pip", "freeze"], stdout=f, check=True)
        print("Fichier 'requirements.txt' g√©n√©r√© avec succ√®s.")
    except Exception as e:
        print(f"Erreur lors de la g√©n√©ration du fichier : {e}")
